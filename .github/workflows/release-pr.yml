name: release-pr

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-pr:
    if: >-
      contains(github.event.pull_request.labels.*.name, 'release') &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install semantic-release
        run: |
          uv venv --python 3.11
          . .venv/bin/activate
          uv pip install python-semantic-release

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Skip if release commit already exists
        run: |
          if git log -1 --pretty=%s | grep -q '^chore(release):'; then
            echo "Release commit already present."
            exit 0
          fi

      - name: Determine next release
        id: next
        run: |
          . .venv/bin/activate
          semantic-release --noop -v version --print | tee /tmp/semrel.log

          if grep -q "No release will be made" /tmp/semrel.log; then
            echo "No release needed."
            echo "release_needed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "release_needed=true" >> "$GITHUB_OUTPUT"

      - name: Bump version and changelog
        if: ${{ steps.next.outputs.release_needed == 'true' }}
        run: |
          . .venv/bin/activate
          semantic-release version --no-push

      - name: Push release commit
        if: ${{ steps.next.outputs.release_needed == 'true' }}
        run: |
          git push origin HEAD:${{ github.event.pull_request.head.ref }}
