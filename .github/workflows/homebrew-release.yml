name: Homebrew Release

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

jobs:
  lint-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install deps
        run: |
          uv venv --python 3.11
          . .venv/bin/activate
          uv pip install -e ".[cli]" ruff pytest

      - name: Ruff
        run: |
          . .venv/bin/activate
          ruff check .

      - name: Pytest
        run: |
          . .venv/bin/activate
          pytest

      - name: Smoke test CLI
        run: |
          . .venv/bin/activate
          python -m dbops --help

  build:
    needs: lint-test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            asset: dbops-darwin-arm64.tar.gz
          - os: macos-15-intel
            asset: dbops-darwin-amd64.tar.gz
          - os: ubuntu-latest
            asset: dbops-linux-amd64.tar.gz

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install deps
        run: |
          uv venv --python 3.11
          . .venv/bin/activate
          uv pip install -e ".[cli]"
          uv pip install "pyinstaller==6.17.0"

      - name: Build (onedir)
        run: |
          . .venv/bin/activate
          rm -rf build dist
          pyinstaller --noconfirm --clean dbops.spec
          test -d dist/dbops

      - name: Package asset
        run: |
          rm -rf package
          mkdir -p package
          cp -R dist/dbops package/dbops
          tar -C package -czf "${{ matrix.asset }}" dbops

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifact names must be unique per workflow run (matrix jobs)
          name: release-${{ matrix.asset }}
          path: ${{ matrix.asset }}
          if-no-files-found: error

  publish-release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          # Download all matrix artifacts
          pattern: release-*
          path: ./assets
          merge-multiple: true

      - name: Install gh
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Create release (if missing) and upload assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          REPO="${GITHUB_REPOSITORY}"

          # Create release if it doesn't exist yet
          if ! gh release view "$TAG" --repo "$REPO" >/dev/null 2>&1; then
            gh release create "$TAG" --repo "$REPO" --title "$TAG" --notes ""
          fi

          # Upload / overwrite assets
          gh release upload "$TAG" --repo "$REPO" ./assets/* --clobber

  update-homebrew-tap:
    needs: publish-release
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Compute tag
        id: ver
        run: |
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          repository: DataRow1/homebrew-brick-ops
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: tap

      - name: Download assets + compute sha256
        id: sha
        run: |
          set -euo pipefail
          TAG="${{ steps.ver.outputs.tag }}"
          BASE="https://github.com/DataRow1/brick-ops/releases/download/${TAG}"

          curl -fsSL "${BASE}/dbops-darwin-arm64.tar.gz" -o arm64.tar.gz
          curl -fsSL "${BASE}/dbops-darwin-amd64.tar.gz" -o amd64.tar.gz
          curl -fsSL "${BASE}/dbops-linux-amd64.tar.gz" -o linux-amd64.tar.gz

          echo "arm64=$(sha256sum arm64.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "amd64=$(sha256sum amd64.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"
          echo "linux_amd64=$(sha256sum linux-amd64.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Update formula
        run: |
          set -euo pipefail
          TAG="${{ steps.ver.outputs.tag }}"
          ARM_SHA="${{ steps.sha.outputs.arm64 }}"
          AMD_SHA="${{ steps.sha.outputs.amd64 }}"
          LINUX_AMD_SHA="${{ steps.sha.outputs.linux_amd64 }}"

          F="tap/Formula/brick-ops.rb"

          python3 - <<'PY'
          import os
          import re
          from pathlib import Path

          formula_path = Path(os.environ.get("F", "tap/Formula/brick-ops.rb"))
          tag = os.environ["TAG"]
          arm_sha = os.environ["ARM_SHA"]
          amd_sha = os.environ["AMD_SHA"]
          linux_amd_sha = os.environ["LINUX_AMD_SHA"]

          txt = formula_path.read_text(encoding="utf-8")

          # 1) Bump tap formula version to match the release tag (Homebrew URLs use #{version}).
          txt, n = re.subn(r'\bversion\s+"[0-9.]+"', f'version "{tag}"', txt)
          if n == 0:
              raise SystemExit("Did not find version line in formula")

          # 2) Canonicalize on_macos and on_linux blocks (repairs corrupted URLs and ensures sha256 lines exist)

          mac_block = (
              '  on_macos do\n'
              '    if Hardware::CPU.arm?\n'
              '      url "https://github.com/DataRow1/brick-ops/releases/download/#{version}/dbops-darwin-arm64.tar.gz"\n'
              f'      sha256 "{arm_sha}"\n'
              '    else\n'
              '      url "https://github.com/DataRow1/brick-ops/releases/download/#{version}/dbops-darwin-amd64.tar.gz"\n'
              f'      sha256 "{amd_sha}"\n'
              '    end\n'
              '  end'
          )

          linux_block = (
              '  on_linux do\n'
              '    url "https://github.com/DataRow1/brick-ops/releases/download/#{version}/dbops-linux-amd64.tar.gz"\n'
              f'    sha256 "{linux_amd_sha}"\n'
              '  end'
          )

          def replace_block(src: str, name: str, replacement: str) -> str:
              pattern = re.compile(rf'^  on_{name} do\n(?:.|\n)*?^  end\n?', re.M)
              if not pattern.search(src):
                  raise SystemExit(f"Did not find on_{name} block to replace")
              return pattern.sub(replacement + "\n\n", src, count=1)

          txt = replace_block(txt, "macos", mac_block)
          txt = replace_block(txt, "linux", linux_block)

          formula_path.write_text(txt, encoding="utf-8")
          print(f"Updated {formula_path} version + sha256 for tag {tag}")
          PY
        env:
          F: tap/Formula/brick-ops.rb
          TAG: ${{ steps.ver.outputs.tag }}
          ARM_SHA: ${{ steps.sha.outputs.arm64 }}
          AMD_SHA: ${{ steps.sha.outputs.amd64 }}
          LINUX_AMD_SHA: ${{ steps.sha.outputs.linux_amd64 }}

      - name: Create PR in tap repo
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: tap
          branch: "update/brick-ops-${{ steps.ver.outputs.tag }}"
          commit-message: "brick-ops ${{ steps.ver.outputs.tag }}"
          title: "brick-ops ${{ steps.ver.outputs.tag }}"
          body: |
            Automated update for brick-ops ${{ steps.ver.outputs.tag }}.
            - updated sha256
          delete-branch: true
